<%= javascript_include_tag "parallel_edit" %>
<%= javascript_include_tag "wmd/wmd" %>
<%= javascript_include_tag "wmd/showdown" %>
<%= stylesheet_link_tag "wmd/wmd" %>
<script type="text/javascript">
    var current_parts = new Array(<%= @page.parts.count %>);
    var saving_time = <%= Bonsai.parallel_edit.saving_time*2000 -%>;
    var notification_message = "<%= t("js.parallel_edit.is_edited") %>";
</script>

<div id="bonsai-main">
  <%= semantic_form_for [:wiki, @page] do |form| %>
      <%= form.input :title %>
      <%= form.input :ordering, :as => :select, :collection => ordering_options_select_values, :include_blank => false %>
      <%= form.select :layout, options_for_select(@user_layouts, @page.layout.to_s), :include_blank => false %>
      <% @page.parts.each do |part| %>
          <%= semantic_fields_for "parts[#{part.id}]", part do |f| %>
              <%= f.input :name %>
              <%= semantic_fields_for "parts[#{part.id}]", part.current_revision do |f| %>
                  <div id="parts_<%= part.id -%>_body_wmd"></div>
                  <%= f.input :body,
                              :input_html => {:onclick => "ajax_add_lock(#{part.id})"}
                  %>
                  <%= f.input :current_revision_id, :value => part.current_revision.id, :as => :hidden %>

                  <script type="text/javascript">
                      setInterval(function() {
                          ajax_update_lock(<%= part.id %>);
                      }, saving_time);
                  </script>
              <% end %>
          <% end %>
      <% end %>
      <%= semantic_fields_for "new_part", @new_part do |p| %>
          <%= p.input :name %>
          <div id="new_part_new_body_wmd"></div>
          <%= p.text_area :new_body %>
      <% end %>
      <%= form.buttons %>
  <% end %>
</div>

<div id="bonsai-sidebar">
  <div id="files">
    <h2>Files</h2>
    <%#= render :partial => 'wiki/files/list' %>

    <%= form_for UploadedFile.new, :url => wiki_page_files_path(@page), :multipart => true, :class => :uploader do |form| %>
        <p>Upload a <%= link_to "new file", nil, :class => :uploader %>.</p>
        <%= form.file_field :file %><%= form.submit %>
    <% end %>
  </div>
  <% if current_user.can_manage?(@page) %>
      <div id="permissions">
        <h2>Permissions</h2>
        <%= render :partial => 'wiki/page_permissions/list' %>
        <h3>Add new permission</h3>
        <%= form_for [:wiki, @page, @page.permissions.build], :remote => true do |f| %>
            <p><%= text_field_tag "page_permission[group_names]", nil, :size => 15, 'data-autocomplete' => quick_search_wiki_groups_path %><%= f.select :role, PagePermission::ROLES %><%= f.submit "Add" %></p>
        <% end %>
      </div>
  <% end %>
</div>
<script type="text/javascript">
    var areas = $('textarea');
    for (var i = 0; i < areas.length; i++) {
        setup_wmd({
            "input": areas[i].id,
            "button_bar": areas[i].id + "_wmd"
        });
    }
</script>